#!/usr/bin/env bash
#
# Claude Code Profile Installer
#
# This script sets up a complete Claude Code environment on a CLEAN system.
# Installs all dependencies: Git, Node.js, Bun, Claude CLI, Gemini CLI, jq
#
# Usage:
#   curl -fsSL https://raw.githubusercontent.com/ample-engineer/.claude/main/install.sh | bash
# Or after cloning:
#   cd ~/.claude && ./install.sh

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log_info() { echo -e "${BLUE}ℹ${NC} $1"; }
log_success() { echo -e "${GREEN}✓${NC} $1"; }
log_warn() { echo -e "${YELLOW}⚠${NC} $1"; }
log_error() { echo -e "${RED}✗${NC} $1"; }

# Track failures for summary
FAILURES=()
add_failure() { FAILURES+=("$1"); }

CLAUDE_HOME="$HOME/.claude"
REPO_URL="https://github.com/ample-engineer/.claude.git"

echo ""
echo "╔════════════════════════════════════════════╗"
echo "║     Claude Code Profile Installer          ║"
echo "║     (Clean System Setup)                   ║"
echo "╚════════════════════════════════════════════╝"
echo ""

# Detect OS and package manager
OS="$(uname -s)"
case "$OS" in
    Linux*)
        PLATFORM="linux"
        if command -v apt-get &> /dev/null; then
            PKG_MANAGER="apt"
        elif command -v dnf &> /dev/null; then
            PKG_MANAGER="dnf"
        elif command -v yum &> /dev/null; then
            PKG_MANAGER="yum"
        elif command -v pacman &> /dev/null; then
            PKG_MANAGER="pacman"
        else
            PKG_MANAGER="unknown"
        fi
        ;;
    Darwin*)
        PLATFORM="mac"
        PKG_MANAGER="brew"
        ;;
    CYGWIN*|MINGW*|MSYS*)
        PLATFORM="windows"
        PKG_MANAGER="none"
        ;;
    *)
        PLATFORM="unknown"
        PKG_MANAGER="unknown"
        ;;
esac
log_info "Platform: $PLATFORM ($PKG_MANAGER)"

# Helper function to install packages
install_pkg() {
    local pkg=$1
    local brew_pkg=${2:-$1}

    case "$PKG_MANAGER" in
        apt)
            sudo apt-get update -qq && sudo apt-get install -y -qq "$pkg"
            ;;
        dnf)
            sudo dnf install -y -q "$pkg"
            ;;
        yum)
            sudo yum install -y -q "$pkg"
            ;;
        pacman)
            sudo pacman -S --noconfirm "$pkg"
            ;;
        brew)
            brew install "$brew_pkg"
            ;;
        *)
            return 1
            ;;
    esac
}

# Step 1: Install Prerequisites
echo ""
echo "── Step 1: Prerequisites ──"

# Install Homebrew on Mac if missing
if [ "$PLATFORM" = "mac" ] && ! command -v brew &> /dev/null; then
    log_info "Installing Homebrew..."
    if /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"; then
        eval "$(/opt/homebrew/bin/brew shellenv)" 2>/dev/null || eval "$(/usr/local/bin/brew shellenv)" 2>/dev/null
        log_success "Homebrew installed"
    else
        log_error "Homebrew installation failed"
        add_failure "Homebrew"
    fi
fi

# Git
if command -v git &> /dev/null; then
    log_success "Git installed: $(git --version | cut -d' ' -f3)"
else
    log_info "Installing Git..."
    if [ "$PLATFORM" = "mac" ]; then
        # Xcode command line tools include git
        if xcode-select --install 2>/dev/null || install_pkg git; then
            log_success "Git installed"
        else
            log_error "Git installation failed"
            add_failure "Git"
        fi
    else
        if install_pkg git; then
            log_success "Git installed"
        else
            log_error "Git installation failed"
            add_failure "Git"
        fi
    fi
fi

# Node.js
if command -v node &> /dev/null; then
    log_success "Node.js installed: $(node --version)"
else
    log_info "Installing Node.js..."
    NODE_INSTALLED=false
    if [ "$PLATFORM" = "mac" ]; then
        if install_pkg node node; then
            NODE_INSTALLED=true
        fi
    elif [ "$PLATFORM" = "linux" ]; then
        # Use NodeSource for latest LTS
        if [ "$PKG_MANAGER" = "apt" ]; then
            if curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash - && sudo apt-get install -y nodejs; then
                NODE_INSTALLED=true
            fi
        elif [ "$PKG_MANAGER" = "dnf" ] || [ "$PKG_MANAGER" = "yum" ]; then
            if curl -fsSL https://rpm.nodesource.com/setup_lts.x | sudo bash - && sudo $PKG_MANAGER install -y nodejs; then
                NODE_INSTALLED=true
            fi
        else
            if install_pkg nodejs; then
                NODE_INSTALLED=true
            fi
        fi
    fi

    if command -v node &> /dev/null; then
        log_success "Node.js installed: $(node --version)"
    else
        log_error "Node.js installation failed"
        log_info "  Install manually from: https://nodejs.org/"
        add_failure "Node.js"
    fi
fi

# jq (for JSON parsing)
if command -v jq &> /dev/null; then
    log_success "jq installed"
else
    log_info "Installing jq..."
    if install_pkg jq jq 2>/dev/null; then
        log_success "jq installed"
    else
        log_warn "Could not install jq - some features may not work"
        add_failure "jq (optional)"
    fi
fi

# tmux (terminal multiplexer - macOS/Linux)
if [ "$PLATFORM" != "windows" ]; then
    if command -v tmux &> /dev/null; then
        log_success "tmux installed: $(tmux -V)"
    else
        log_info "Installing tmux..."
        if install_pkg tmux tmux 2>/dev/null; then
            log_success "tmux installed"
        else
            log_warn "Could not install tmux - optional for development"
            add_failure "tmux (optional)"
        fi
    fi
fi

# Bun
if command -v bun &> /dev/null; then
    BUN_PATH="bun"
    log_success "Bun installed: $(bun --version)"
elif [ -f "$HOME/.bun/bin/bun" ]; then
    BUN_PATH="$HOME/.bun/bin/bun"
    log_success "Bun installed: $($BUN_PATH --version)"
else
    log_info "Installing Bun..."
    if curl -fsSL https://bun.sh/install | bash; then
        export PATH="$HOME/.bun/bin:$PATH"
        BUN_PATH="$HOME/.bun/bin/bun"
        if [ -f "$BUN_PATH" ]; then
            log_success "Bun installed: $($BUN_PATH --version)"

            # Add Bun to shell profile for persistent PATH
            if [ "$PLATFORM" = "mac" ]; then
                SHELL_PROFILE="$HOME/.zshrc"
                [ ! -f "$SHELL_PROFILE" ] && touch "$SHELL_PROFILE"
            elif [ -f "$HOME/.zshrc" ]; then
                SHELL_PROFILE="$HOME/.zshrc"
            else
                SHELL_PROFILE="$HOME/.bashrc"
            fi
            if ! grep -q "\.bun/bin" "$SHELL_PROFILE" 2>/dev/null; then
                echo "" >> "$SHELL_PROFILE"
                echo "# Bun (added by Claude Code installer)" >> "$SHELL_PROFILE"
                echo "export PATH=\"\$HOME/.bun/bin:\$PATH\"" >> "$SHELL_PROFILE"
                log_info "Added Bun to PATH in $SHELL_PROFILE"
            fi
        else
            log_error "Bun installation failed"
            add_failure "Bun"
        fi
    else
        log_error "Bun installation failed"
        log_info "  Install manually: curl -fsSL https://bun.sh/install | bash"
        add_failure "Bun"
    fi
fi

# Claude Code CLI
if command -v claude &> /dev/null; then
    log_success "Claude Code CLI installed: $(claude --version 2>/dev/null || echo 'version unknown')"
else
    log_info "Installing Claude Code CLI..."
    if command -v npm &> /dev/null; then
        # Configure npm to use user directory (no sudo needed)
        NPM_PREFIX="$HOME/.npm-global"
        if [ ! -d "$NPM_PREFIX" ]; then
            mkdir -p "$NPM_PREFIX"
            npm config set prefix "$NPM_PREFIX"
            log_info "Configured npm to use $NPM_PREFIX (no sudo needed)"
        fi

        # Add to PATH for this session
        export PATH="$NPM_PREFIX/bin:$PATH"

        # Add to shell profile if not already there
        # Prefer zshrc on Mac (default shell), create if needed
        if [ "$PLATFORM" = "mac" ]; then
            SHELL_PROFILE="$HOME/.zshrc"
            [ ! -f "$SHELL_PROFILE" ] && touch "$SHELL_PROFILE"
        elif [ -f "$HOME/.zshrc" ]; then
            SHELL_PROFILE="$HOME/.zshrc"
        else
            SHELL_PROFILE="$HOME/.bashrc"
        fi
        if ! grep -q "npm-global" "$SHELL_PROFILE" 2>/dev/null; then
            echo "" >> "$SHELL_PROFILE"
            echo "# npm global packages (added by Claude Code installer)" >> "$SHELL_PROFILE"
            echo "export PATH=\"\$HOME/.npm-global/bin:\$PATH\"" >> "$SHELL_PROFILE"
            log_info "Added npm-global to PATH in $SHELL_PROFILE"
        fi

        # Install without sudo
        if npm install -g @anthropic-ai/claude-code 2>&1; then
            if command -v claude &> /dev/null; then
                log_success "Claude Code CLI installed"
            else
                log_warn "Claude Code CLI installed to $NPM_PREFIX/bin/claude"
                log_info "  Restart terminal or run: export PATH=\"\$HOME/.npm-global/bin:\$PATH\""
            fi
        else
            log_error "Claude Code CLI installation failed"
            log_info "  Try manually: npm install -g @anthropic-ai/claude-code"
            add_failure "Claude Code CLI"
        fi
    else
        log_error "npm not available - cannot install Claude Code CLI"
        log_info "  Install Node.js first, then run this script again"
        add_failure "Claude Code CLI (npm missing)"
    fi
fi

# Gemini CLI
if command -v gemini &> /dev/null; then
    log_success "Gemini CLI installed"
else
    log_info "Installing Gemini CLI..."
    if command -v npm &> /dev/null; then
        # Uses the same npm-global prefix configured above
        if npm install -g @google/gemini-cli 2>&1; then
            if command -v gemini &> /dev/null; then
                log_success "Gemini CLI installed"
                log_info "  Run 'gemini' to login interactively on first use"
            else
                log_warn "Gemini CLI installed but not in PATH yet (restart terminal)"
            fi
        else
            log_warn "Could not install Gemini CLI"
            log_info "  Install manually: npm install -g @google/gemini-cli"
            add_failure "Gemini CLI (optional)"
        fi
    else
        log_warn "npm not available, skipping Gemini CLI install"
        add_failure "Gemini CLI (npm missing)"
    fi
fi

# GitHub Copilot CLI (for terminal assistance & GitHub operations)
COPILOT_INSTALLED=false
if command -v copilot &> /dev/null; then
    log_success "GitHub Copilot CLI installed"
    COPILOT_INSTALLED=true
else
    log_info "Installing GitHub Copilot CLI..."
    if [ "$PLATFORM" = "mac" ]; then
        # Prefer Homebrew on Mac
        if command -v brew &> /dev/null; then
            if brew install copilot-cli 2>/dev/null; then
                log_success "GitHub Copilot CLI installed via Homebrew"
                COPILOT_INSTALLED=true
            else
                log_warn "Homebrew install failed, trying npm..."
            fi
        fi
    fi

    # Fall back to npm on all platforms
    if [ "$COPILOT_INSTALLED" = false ] && command -v npm &> /dev/null; then
        if npm install -g @github/copilot 2>&1; then
            if command -v copilot &> /dev/null || [ -f "$NPM_PREFIX/bin/copilot" ]; then
                log_success "GitHub Copilot CLI installed via npm"
                COPILOT_INSTALLED=true
            else
                log_warn "GitHub Copilot CLI installed but not in PATH yet (restart terminal)"
                COPILOT_INSTALLED=true
            fi
        else
            log_warn "Could not install GitHub Copilot CLI"
            log_info "  Install manually: npm install -g @github/copilot"
            log_info "  Requires GitHub Copilot Pro subscription"
            add_failure "GitHub Copilot CLI (optional)"
        fi
    elif [ "$COPILOT_INSTALLED" = false ]; then
        log_warn "npm not available, skipping GitHub Copilot CLI install"
        add_failure "GitHub Copilot CLI (npm missing)"
    fi
fi

# Bitwarden CLI (for Vaultwarden access)
BW_INSTALLED=false
if command -v bw &> /dev/null; then
    log_success "Bitwarden CLI installed: $(bw --version 2>/dev/null || echo 'version unknown')"
    BW_INSTALLED=true
else
    log_info "Installing Bitwarden CLI..."
    if command -v npm &> /dev/null; then
        if npm install -g @bitwarden/cli 2>&1; then
            # Check in npm-global path
            if [ -f "$NPM_PREFIX/bin/bw" ] || command -v bw &> /dev/null; then
                log_success "Bitwarden CLI installed"
                BW_INSTALLED=true
            else
                log_warn "Bitwarden CLI installed but not in PATH yet (restart terminal)"
                BW_INSTALLED=true
            fi
        else
            log_warn "Could not install Bitwarden CLI"
            log_info "  Install manually: npm install -g @bitwarden/cli"
            add_failure "Bitwarden CLI (optional)"
        fi
    else
        log_warn "npm not available, skipping Bitwarden CLI install"
        add_failure "Bitwarden CLI (npm missing)"
    fi
fi

# Configure Bitwarden for Vaultwarden server (BNX - autonomous access)
if [ "$BW_INSTALLED" = true ]; then
    VAULTWARDEN_SERVER="https://vault.boroughnexus.com"
    if command -v bw &> /dev/null; then
        BW_CMD="bw"
    elif [ -f "$NPM_PREFIX/bin/bw" ]; then
        BW_CMD="$NPM_PREFIX/bin/bw"
    else
        BW_CMD=""
    fi

    if [ -n "$BW_CMD" ]; then
        log_info "Configuring Bitwarden for Vaultwarden..."
        if $BW_CMD config server "$VAULTWARDEN_SERVER" 2>/dev/null; then
            log_success "Bitwarden configured for $VAULTWARDEN_SERVER"
        else
            log_warn "Could not configure Bitwarden server (may already be set)"
        fi
    fi
fi

# Offer to set up Keychain credentials for Claude autonomous vault access (macOS only)
if [[ "$OSTYPE" == "darwin"* ]] && command -v bun &> /dev/null; then
    KEYCHAIN_SETUP="$CLAUDE_HOME/tools/vaultwarden/setup-keychain.ts"
    if [ -f "$KEYCHAIN_SETUP" ]; then
        echo ""
        log_info "Vault Keychain Setup (optional)"
        log_info "  Stores claude@boroughnexus.com API credentials in Secure Enclave"
        log_info "  Enables Claude autonomous RO access to BNX vault"
        echo ""
        read -p "Set up Keychain credentials now? (y/N): " setup_keychain
        if [[ "$setup_keychain" =~ ^[Yy]$ ]]; then
            bun run "$KEYCHAIN_SETUP"
        else
            log_info "Skipped. Run later: bun run $KEYCHAIN_SETUP"
        fi
    fi
fi

# Step 2: Clone or Update Repository
echo ""
echo "── Step 2: Repository ──"

if [ -d "$CLAUDE_HOME/.git" ]; then
    log_info "Existing repo found, updating..."
    cd "$CLAUDE_HOME"
    if git pull --rebase; then
        log_success "Repository updated"
    else
        log_warn "Git pull failed, continuing with existing files"
    fi
else
    if [ -d "$CLAUDE_HOME" ]; then
        log_info "Backing up existing ~/.claude to ~/.claude.backup"
        mv "$CLAUDE_HOME" "$HOME/.claude.backup.$(date +%s)"
    fi
    log_info "Cloning repository..."
    if git clone "$REPO_URL" "$CLAUDE_HOME"; then
        log_success "Repository cloned"
    else
        log_error "Failed to clone repository"
        add_failure "Repository clone"
        echo ""
        log_error "Cannot continue without repository. Exiting."
        exit 1
    fi
fi

cd "$CLAUDE_HOME"

# Step 3: Generate settings.json
echo ""
echo "── Step 3: Configuration ──"

if [ -f "settings.template.json" ]; then
    log_info "Generating settings.json..."

    # Select appropriate statusline script based on platform
    if [ "$PLATFORM" = "windows" ]; then
        STATUSLINE_PATH="$CLAUDE_HOME\\statuslines\\statusline.ps1"
    else
        STATUSLINE_PATH="$CLAUDE_HOME/statuslines/statusline.sh"
    fi

    if sed -e "s|{{BUN_PATH}}|$BUN_PATH|g" \
           -e "s|{{CLAUDE_HOME}}|$CLAUDE_HOME|g" \
           -e "s|{{STATUSLINE_PATH}}|$STATUSLINE_PATH|g" \
           settings.template.json > settings.json; then
        log_success "settings.json generated"
    else
        log_error "Failed to generate settings.json"
        add_failure "settings.json"
    fi
else
    log_warn "settings.template.json not found, skipping settings generation"
fi

# Step 4: Generate slash commands from templates
log_info "Generating slash commands..."

mkdir -p commands

if [ -f "commands/telegram.template.md" ]; then
    sed -e "s|{{BUN_PATH}}|$BUN_PATH|g" \
        -e "s|{{CLAUDE_HOME}}|$CLAUDE_HOME|g" \
        commands/telegram.template.md > commands/telegram.md
fi

if [ -f "commands/telegram-end.template.md" ]; then
    sed -e "s|{{BUN_PATH}}|$BUN_PATH|g" \
        -e "s|{{CLAUDE_HOME}}|$CLAUDE_HOME|g" \
        commands/telegram-end.template.md > commands/telegram-end.md
fi

if [ -f "commands/vault.template.md" ]; then
    sed -e "s|{{BUN_PATH}}|$BUN_PATH|g" \
        -e "s|{{CLAUDE_HOME}}|$CLAUDE_HOME|g" \
        commands/vault.template.md > commands/vault.md
fi

if [ -f "commands/aipeerreview.md" ]; then
    sed -i.bak -e "s|{{BUN_PATH}}|$BUN_PATH|g" \
        -e "s|{{CLAUDE_HOME}}|$CLAUDE_HOME|g" \
        commands/aipeerreview.md
    rm -f commands/aipeerreview.md.bak
fi

if [ -f "commands/z.md" ]; then
    sed -i.bak -e "s|{{BUN_PATH}}|$BUN_PATH|g" \
        -e "s|{{CLAUDE_HOME}}|$CLAUDE_HOME|g" \
        commands/z.md
    rm -f commands/z.md.bak
fi

log_success "Slash commands generated"

# Step 5: Install Telegram integration dependencies
echo ""
echo "── Step 4: Dependencies ──"

if [ -d "hooks/telegram-bun" ]; then
    log_info "Installing Telegram integration dependencies..."
    cd hooks/telegram-bun
    if $BUN_PATH install 2>/dev/null; then
        log_success "Telegram dependencies installed"
    else
        log_warn "Bun install had warnings or failed"
        add_failure "Telegram dependencies (optional)"
    fi
    cd "$CLAUDE_HOME"
fi

# Make scripts executable
chmod +x setup.sh hooks/telegram-bun/run.sh 2>/dev/null || true

# Step 6: Apply secrets from repo
echo ""
echo "── Step 5: Secrets ──"

if [ -f "$CLAUDE_HOME/secrets.json" ]; then
    log_info "Applying secrets from secrets.json..."
    if command -v jq &> /dev/null; then
        BOT_TOKEN=$(jq -r '.telegram.bot_token // empty' "$CLAUDE_HOME/secrets.json")
        CHAT_ID=$(jq -r '.telegram.chat_id // empty' "$CLAUDE_HOME/secrets.json")

        if [ -n "$BOT_TOKEN" ] && [ "$BOT_TOKEN" != "YOUR_BOT_TOKEN" ]; then
            log_info "Configuring Telegram..."
            if $BUN_PATH run "$CLAUDE_HOME/hooks/telegram-bun/index.ts" config "$BOT_TOKEN" "$CHAT_ID"; then
                log_success "Telegram configured"
            else
                log_warn "Telegram configuration may have failed"
                add_failure "Telegram config (optional)"
            fi
        fi

        # Export API keys as env vars
        FIRECRAWL_KEY=$(jq -r '.api_keys.firecrawl // empty' "$CLAUDE_HOME/secrets.json")

        if [ -n "$FIRECRAWL_KEY" ] && [ "$FIRECRAWL_KEY" != "YOUR_FIRECRAWL_API_KEY" ]; then
            log_info "Found Firecrawl API key - adding to shell profile..."
            # Prefer zshrc on Mac (default shell), create if needed
            if [ "$PLATFORM" = "mac" ]; then
                SHELL_PROFILE="$HOME/.zshrc"
                [ ! -f "$SHELL_PROFILE" ] && touch "$SHELL_PROFILE"
            elif [ -f "$HOME/.zshrc" ]; then
                SHELL_PROFILE="$HOME/.zshrc"
            else
                SHELL_PROFILE="$HOME/.bashrc"
            fi

            if ! grep -q "FIRECRAWL_API_KEY" "$SHELL_PROFILE" 2>/dev/null; then
                echo "" >> "$SHELL_PROFILE"
                echo "# Firecrawl API key (added by Claude Code installer)" >> "$SHELL_PROFILE"
                echo "export FIRECRAWL_API_KEY='$FIRECRAWL_KEY'" >> "$SHELL_PROFILE"
                log_success "Firecrawl API key added to $SHELL_PROFILE"
            else
                log_info "Firecrawl API key already in $SHELL_PROFILE"
            fi
        fi
        log_success "Secrets applied"
    else
        log_warn "jq not installed, cannot parse secrets.json"
        log_info "  Install jq and re-run to apply secrets"
        add_failure "Secrets (jq missing)"
    fi
else
    log_info "No secrets.json found - create one from secrets.template.json"
fi

# Step 7: Install MCP Servers
echo ""
echo "── Step 6: MCP Servers ──"

if command -v claude &> /dev/null && [ -f "mcp-servers.json" ]; then
    log_info "Installing MCP servers..."

    # Parse mcp-servers.json and install each
    if command -v jq &> /dev/null; then
        # Use while loop to handle JSON properly
        jq -c '.servers[]' mcp-servers.json | while IFS= read -r row; do
            name=$(echo "$row" | jq -r '.name')
            cmd=$(echo "$row" | jq -r '.command')

            # Build env var arguments
            env_args=""
            if echo "$row" | jq -e '.env' >/dev/null 2>&1; then
                # Extract env vars and substitute placeholders
                while IFS='=' read -r key value; do
                    # Skip if key is empty
                    [ -z "$key" ] && continue
                    # Substitute known placeholders
                    value=$(echo "$value" | sed -e "s|{{CLAUDE_HOME}}|$CLAUDE_HOME|g" \
                                                -e "s|{{HOME}}|$HOME|g" \
                                                -e "s|{{BUN_PATH}}|$BUN_PATH|g")
                    # Skip env vars with unsubstituted placeholders (missing secrets)
                    if echo "$value" | grep -q '{{'; then
                        log_warn "    Skipping env $key (missing secret)"
                        continue
                    fi
                    env_args="$env_args -e $key=$value"
                done < <(echo "$row" | jq -r '.env | to_entries[] | "\(.key)=\(.value)"')
            fi

            log_info "  Adding MCP server: $name"
            # Remove existing server first to update config
            claude mcp remove "$name" -s user 2>/dev/null || true
            if eval "claude mcp add \"$name\" --transport stdio -s user $env_args -- $cmd" 2>/dev/null; then
                log_success "  $name added"
            else
                log_warn "  Failed to add $name"
            fi
        done
        log_success "MCP servers configured"
    else
        log_warn "jq not installed, skipping MCP server auto-install"
        log_info "  Install jq and re-run, or manually add MCP servers"
        add_failure "MCP servers (jq missing)"
    fi
else
    if ! command -v claude &> /dev/null; then
        log_warn "Claude CLI not installed, skipping MCP setup"
        log_info "  After installing Claude CLI, re-run this script"
        add_failure "MCP servers (claude missing)"
    fi
fi

# Step 8: Apply tmux configuration
echo ""
echo "── Step 7: Terminal Configuration ──"

if [ "$PLATFORM" != "windows" ] && command -v tmux &> /dev/null; then
    log_info "Configuring tmux..."
    if [ -f "$CLAUDE_HOME/tmux.conf" ]; then
        # Backup existing config if it exists
        if [ -f "$HOME/.tmux.conf" ]; then
            log_info "Backing up existing ~/.tmux.conf"
            cp "$HOME/.tmux.conf" "$HOME/.tmux.conf.backup.$(date +%s)"
        fi

        # Copy tmux config
        if cp "$CLAUDE_HOME/tmux.conf" "$HOME/.tmux.conf"; then
            log_success "tmux configured: ~/.tmux.conf"
        else
            log_warn "Could not copy tmux config"
            add_failure "tmux config (optional)"
        fi
    fi

    # Install TPM and plugins for session persistence
    log_info "Installing tmux plugins (session persistence)..."
    TMUX_PLUGINS="$HOME/.tmux/plugins"
    mkdir -p "$TMUX_PLUGINS"

    # TPM (Tmux Plugin Manager)
    if [ ! -d "$TMUX_PLUGINS/tpm" ]; then
        if git clone https://github.com/tmux-plugins/tpm "$TMUX_PLUGINS/tpm" 2>/dev/null; then
            log_success "TPM installed"
        else
            log_warn "Could not install TPM"
            add_failure "TPM (optional)"
        fi
    else
        log_success "TPM already installed"
    fi

    # tmux-resurrect (save/restore sessions)
    if [ ! -d "$TMUX_PLUGINS/tmux-resurrect" ]; then
        if git clone https://github.com/tmux-plugins/tmux-resurrect "$TMUX_PLUGINS/tmux-resurrect" 2>/dev/null; then
            log_success "tmux-resurrect installed"
        else
            log_warn "Could not install tmux-resurrect"
            add_failure "tmux-resurrect (optional)"
        fi
    else
        log_success "tmux-resurrect already installed"
    fi

    # tmux-continuum (auto-save/restore)
    if [ ! -d "$TMUX_PLUGINS/tmux-continuum" ]; then
        if git clone https://github.com/tmux-plugins/tmux-continuum "$TMUX_PLUGINS/tmux-continuum" 2>/dev/null; then
            log_success "tmux-continuum installed"
        else
            log_warn "Could not install tmux-continuum"
            add_failure "tmux-continuum (optional)"
        fi
    else
        log_success "tmux-continuum already installed"
    fi
fi

# Step 9: Quota Fetcher Setup (macOS only)
if [ "$PLATFORM" = "mac" ]; then
    echo ""
    echo "── Step 8: Quota Fetcher (macOS) ──"

    if [ -d "$CLAUDE_HOME/quota-fetcher" ]; then
        log_info "Setting up Claude Max quota fetcher..."

        # Install quota-fetcher dependencies
        cd "$CLAUDE_HOME/quota-fetcher"
        if [ -f "package.json" ]; then
            if $BUN_PATH install 2>/dev/null; then
                log_success "Quota fetcher dependencies installed"
            else
                log_warn "Could not install quota-fetcher dependencies"
                add_failure "quota-fetcher deps (optional)"
            fi
        fi
        cd "$CLAUDE_HOME"

        # Set up launchd plist for periodic quota fetching
        PLIST_TEMPLATE="$CLAUDE_HOME/quota-fetcher/com.claude.quota-fetcher.plist.template"
        PLIST_DST="$HOME/Library/LaunchAgents/com.claude.quota-fetcher.plist"

        if [ -f "$PLIST_TEMPLATE" ] && [ -f "$CLAUDE_HOME/quota-fetcher/fetch-quota.ts" ]; then
            # Generate plist from template
            sed -e "s|{{HOME}}|$HOME|g" \
                -e "s|{{CLAUDE_HOME}}|$CLAUDE_HOME|g" \
                "$PLIST_TEMPLATE" > "$PLIST_DST"
            log_success "Quota fetcher launchd plist installed"
            log_info "  To start: launchctl load $PLIST_DST"
            log_info "  First run (login): $BUN_PATH run $CLAUDE_HOME/quota-fetcher/fetch-quota.ts --login"
        else
            log_info "Quota fetcher template not found, skipping launchd setup"
        fi
    else
        log_info "Quota fetcher not found, skipping"
    fi
fi

# Step 10: macOS Performance Tips
if [ "$PLATFORM" = "mac" ]; then
    echo ""
    echo "── Step 9: macOS Performance Tips ──"
    log_info "For faster fullscreen/space switching animations:"
    echo "     System Settings → Accessibility → Display → Reduce motion (ON)"
    log_info "This makes space transitions instant crossfades instead of slow slides."
fi

# Step 11: Obsidian Setup (macOS/Linux)
echo ""
echo "── Step 10: Obsidian Setup ──"

OBSIDIAN_INSTALLED=false

# Check if Obsidian is already installed
if [ "$PLATFORM" = "mac" ]; then
    if [ -d "/Applications/Obsidian.app" ]; then
        log_success "Obsidian already installed"
        OBSIDIAN_INSTALLED=true
    else
        log_info "Installing Obsidian..."
        if brew install --cask obsidian 2>/dev/null; then
            log_success "Obsidian installed"
            OBSIDIAN_INSTALLED=true
        else
            log_warn "Could not install Obsidian via Homebrew"
            log_info "  Install manually from: https://obsidian.md/download"
            add_failure "Obsidian (optional)"
        fi
    fi
elif [ "$PLATFORM" = "linux" ]; then
    if command -v obsidian &> /dev/null || [ -f "/usr/bin/obsidian" ] || [ -f "$HOME/.local/bin/obsidian" ]; then
        log_success "Obsidian already installed"
        OBSIDIAN_INSTALLED=true
    else
        log_info "Installing Obsidian..."
        # Try Flatpak first (most universal)
        if command -v flatpak &> /dev/null; then
            if flatpak install -y flathub md.obsidian.Obsidian 2>/dev/null; then
                log_success "Obsidian installed via Flatpak"
                OBSIDIAN_INSTALLED=true
            fi
        fi
        # Try Snap as fallback
        if [ "$OBSIDIAN_INSTALLED" = false ] && command -v snap &> /dev/null; then
            if sudo snap install obsidian --classic 2>/dev/null; then
                log_success "Obsidian installed via Snap"
                OBSIDIAN_INSTALLED=true
            fi
        fi
        if [ "$OBSIDIAN_INSTALLED" = false ]; then
            log_warn "Could not install Obsidian automatically"
            log_info "  Install manually from: https://obsidian.md/download"
            add_failure "Obsidian (optional)"
        fi
    fi
fi

# Create Obsidian vault directory
OBSIDIAN_VAULT="$HOME/Obsidian/Simon-Personal"
if [ "$OBSIDIAN_INSTALLED" = true ]; then
    if [ ! -d "$OBSIDIAN_VAULT" ]; then
        log_info "Creating Obsidian vault directory..."
        mkdir -p "$OBSIDIAN_VAULT"
        log_success "Vault directory created: $OBSIDIAN_VAULT"
    else
        log_success "Obsidian vault directory exists: $OBSIDIAN_VAULT"
    fi

    # Set up Obsidian Sync config if this is macOS
    if [ "$PLATFORM" = "mac" ]; then
        OBSIDIAN_CONFIG="$HOME/Library/Application Support/obsidian"
        if [ ! -d "$OBSIDIAN_CONFIG" ]; then
            mkdir -p "$OBSIDIAN_CONFIG"
            log_info "Created Obsidian config directory"
        fi

        # Check if Obsidian needs to be launched for initial setup
        if [ ! -f "$OBSIDIAN_CONFIG/obsidian.json" ]; then
            log_info "Obsidian Sync requires initial GUI login."
            log_info "  On headless systems, copy config from another machine:"
            log_info "  1. From primary Mac: scp ~/Library/Application\\ Support/obsidian/obsidian.json user@headless:~/Library/Application\\ Support/obsidian/"
            log_info "  2. Or launch Obsidian via VNC/screen sharing for initial setup"
            add_failure "Obsidian Sync (needs manual config)"
        else
            log_success "Obsidian config exists"
            # Check if sync is configured
            if grep -q "sync" "$OBSIDIAN_CONFIG/obsidian.json" 2>/dev/null; then
                log_success "Obsidian Sync appears to be configured"
            else
                log_warn "Obsidian Sync may not be configured"
                log_info "  Launch Obsidian and enable Sync in settings"
            fi
        fi
    fi
fi

# Step 12: Final setup reminders
echo ""
echo "── Step 11: Post-Install ──"

# Remind about Gemini login
if command -v gemini &> /dev/null; then
    log_info "Gemini CLI needs interactive login. Run:"
    echo "    gemini"
    echo "  and follow the prompts to authenticate with Google."
fi

# Summary
echo ""
if [ ${#FAILURES[@]} -eq 0 ]; then
    echo "╔════════════════════════════════════════════╗"
    echo -e "║  ${GREEN}Installation Complete - All Steps Passed!${NC}  ║"
    echo "╚════════════════════════════════════════════╝"
else
    echo "╔════════════════════════════════════════════╗"
    echo -e "║  ${YELLOW}Installation Complete - With Issues${NC}        ║"
    echo "╚════════════════════════════════════════════╝"
    echo ""
    log_warn "The following steps had issues:"
    for failure in "${FAILURES[@]}"; do
        echo -e "  ${RED}✗${NC} $failure"
    done
fi

echo ""
log_success "Claude Code profile installed to: $CLAUDE_HOME"
echo ""
# Detect shell profile for reload hint
SHELL_NAME=$(basename "$SHELL")
if [ "$SHELL_NAME" = "zsh" ]; then
    RELOAD_CMD="source ~/.zshrc"
elif [ "$SHELL_NAME" = "bash" ]; then
    RELOAD_CMD="source ~/.bashrc"
else
    RELOAD_CMD="source ~/.profile"
fi

log_info "Next steps:"
if ! command -v claude &> /dev/null; then
    echo -e "  ${RED}1. REQUIRED: Install Claude CLI:${NC}"
    echo "     npm install -g @anthropic-ai/claude-code"
    echo "  2. Reload shell: $RELOAD_CMD"
    echo "  3. Run 'claude' to start Claude Code"
else
    echo "  1. Reload shell (or restart terminal):"
    echo "     $RELOAD_CMD"
    echo "  2. Run 'claude' to start Claude Code"
fi
if command -v gemini &> /dev/null; then
    echo "  3. Run 'gemini' to login to Gemini (for second opinions)"
fi
if [ "$COPILOT_INSTALLED" = true ]; then
    echo "  4. Run 'copilot' to login to GitHub Copilot (for terminal help)"
fi
echo "  5. Use /telegram in Claude to enable Telegram integration"
if [ "$BW_INSTALLED" = true ]; then
    echo ""
    echo "  Vaultwarden setup (one-time):"
    echo "     bw login"
    echo "     bw unlock"
    echo "  Then use /vault in Claude to access credentials"
fi
if [ "$OBSIDIAN_INSTALLED" = true ]; then
    echo ""
    echo "  Obsidian Sync setup (headless systems):"
    echo "     Option A: Copy config from another machine:"
    echo "       scp user@primary:~/Library/Application\\ Support/obsidian/* ~/Library/Application\\ Support/obsidian/"
    echo "     Option B: Use VNC/Screen Sharing for initial GUI setup"
    echo "     Vault location: $OBSIDIAN_VAULT"
fi
echo ""
